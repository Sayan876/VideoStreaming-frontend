import axios from "axios";
import React, { useEffect, useState, useRef } from "react";
import { useNavigate } from "react-router-dom";

const UserDetails = () => {
  const navigate = useNavigate();
  const [user, setUser] = useState(null);
  const [videos, setVideos] = useState([]);
  const [editingIndex, setEditingIndex] = useState(null);
  const [editData, setEditData] = useState({ title: "", description: "" });
  const [profileFile, setProfileFile] = useState(null);
  const [showProfileEdit, setShowProfileEdit] = useState(false);
  const [profileEditData, setProfileEditData] = useState({
    name: "",
    password: "",
    confirmPassword: "",
    country: "",
    biodetails: "",
  });
  const [passwordError, setPasswordError] = useState("");
  const [uploadData, setUploadData] = useState({
    title: "",
    description: "",
    file: null,
  });
  const [uploading, setUploading] = useState(false);
  const videoRefs = useRef([]);

  // ---------------- Fetch User ----------------
  useEffect(() => {
    const isLoggedIn = localStorage.getItem("isLoggedIn");
    const storedId = localStorage.getItem("userId");

    if (!isLoggedIn || !storedId) {
      navigate("/login");
      return;
    }

    axios
      .get(`http://localhost:8080/api/user/${storedId}`)
      .then((resp) => setUser(resp.data))
      .catch(() => {
        console.log("Cannot fetch user data");
        navigate("/login");
      });
  }, [navigate]);

  const fetchVideos = () => {
    if (!user?.id) return;

    axios
      .get(`http://localhost:8080/api/v3/videos/byUserId/${user.id}`)
      .then((resp) => setVideos(resp.data))
      .catch(() => console.log("Cannot fetch videos"));
  };

  useEffect(() => {
    fetchVideos();
  }, [user]);

  const handleLogout = () => {
    localStorage.removeItem("isLoggedIn");
    localStorage.removeItem("userId");
    navigate("/login");
  };

  const handlePlay = (index) => {
    videoRefs.current.forEach((vid, i) => {
      if (vid && i !== index) vid.pause();
    });
  };

  // ---------------- Video Edit/Delete ----------------
  const startEdit = (index) => {
    setEditingIndex(index);
    setEditData({
      title: videos[index].title,
      description: videos[index].description,
    });
  };

  const cancelEdit = () => {
    setEditingIndex(null);
    setEditData({ title: "", description: "" });
  };

  const saveEdit = async (videoId) => {
    try {
      const formData = new FormData();
      formData.append("title", editData.title);
      formData.append("description", editData.description);

      await axios.patch(`http://localhost:8080/api/v3/videos/${videoId}`, formData, {
        headers: { "Content-Type": "multipart/form-data" },
      });

      fetchVideos();
      cancelEdit();
    } catch (err) {
      console.log("Error updating video", err);
    }
  };

  const deleteVideo = async (videoId) => {
    if (!window.confirm("Are you sure you want to delete this video?")) return;
    try {
      await axios.delete(`http://localhost:8080/api/v3/videos/${videoId}`);
      fetchVideos();
    } catch (err) {
      console.log("Error deleting video", err);
    }
  };

  // ---------------- Profile Picture ----------------
  const handleFileChange = (e) => setProfileFile(e.target.files[0]);

  const uploadProfilePic = async () => {
    if (!profileFile) return;
    try {
      const formData = new FormData();
      formData.append("profilePic", profileFile);

      const userId = localStorage.getItem("userId");
      await axios.patch(`http://localhost:8080/api/user/${userId}`, formData, {
        headers: { "Content-Type": "multipart/form-data" },
      });

      const resp = await axios.get(`http://localhost:8080/api/user/${userId}`);
      setUser(resp.data);
      setProfileFile(null);
      alert("Profile picture updated!");
    } catch (err) {
      console.log("Error uploading profile picture", err);
    }
  };

  const deleteProfilePic = async () => {
    if (!window.confirm("Are you sure you want to delete your profile picture?")) return;
    try {
      const userId = localStorage.getItem("userId");
      await axios.delete(`http://localhost:8080/api/user/delpro/${userId}`);
      const resp = await axios.get(`http://localhost:8080/api/user/${userId}`);
      setUser(resp.data);
      alert("Profile picture deleted!");
    } catch (err) {
      console.log("Error deleting profile picture", err);
    }
  };

  // ---------------- Edit Profile Details ----------------
  const openProfileEdit = () => {
    setProfileEditData({
      name: user.name || "",
      password: user.password || "",
      confirmPassword: user.password || "",
      country: user.country || "",
      biodetails: user.biodetails || "",
    });
    setPasswordError("");
    setShowProfileEdit(true);
  };

  const closeProfileEdit = () => setShowProfileEdit(false);

  const saveProfileChanges = async () => {
    if (profileEditData.password !== profileEditData.confirmPassword) {
      setPasswordError("Passwords do not match!");
      return;
    }

    try {
      const userId = localStorage.getItem("userId");
      const formData = new FormData();
      formData.append("name", profileEditData.name);
      formData.append("password", profileEditData.password);
      formData.append("country", profileEditData.country);
      formData.append("biodetails", profileEditData.biodetails);

      await axios.patch(`http://localhost:8080/api/userdet/${userId}`, formData, {
        headers: { "Content-Type": "multipart/form-data" },
      });

      const resp = await axios.get(`http://localhost:8080/api/user/${userId}`);
      setUser(resp.data);
      setShowProfileEdit(false);
      alert("Profile details updated successfully!");
    } catch (err) {
      console.log("Error updating profile details", err);
      alert("Failed to update profile details.");
    }
  };

  // ---------------- Video Upload Feature ----------------
  const handleVideoChange = (e) => setUploadData({ ...uploadData, file: e.target.files[0] });

  const handleUpload = async () => {
    if (!uploadData.file || !uploadData.title) {
      alert("Please select a video file and enter a title!");
      return;
    }
    setUploading(true);

    try {
      const formData = new FormData();
      formData.append("file", uploadData.file);
      formData.append("title", uploadData.title);
      formData.append("description", uploadData.description);

      await axios.post(`http://localhost:8080/api/v3/videos/${user.id}`, formData, {
        headers: { "Content-Type": "multipart/form-data" },
      });

      alert("Video uploaded successfully!");
      setUploadData({ title: "", description: "", file: null });
      fetchVideos();
    } catch (err) {
      console.log("Error uploading video", err);
      alert("Failed to upload video!");
    } finally {
      setUploading(false);
    }
  };

  if (!user) return <p style={{ color: "white" }}>Loading user...</p>;

  const deleteAccount = async () => {
  if (!window.confirm("‚ö†Ô∏è Are you sure you want to delete your account permanently? This action cannot be undone.")) return;

  try {
    const userId = localStorage.getItem("userId");
    await axios.delete(`http://localhost:8080/api/user/${userId}`);
    
    alert("Your account has been deleted successfully.");
    localStorage.removeItem("isLoggedIn");
    localStorage.removeItem("userId");
    navigate("/signup"); // redirect after deletion
  } catch (err) {
    console.error("Error deleting account:", err);
    alert("Failed to delete account. Please try again later.");
  }
};


  // ---------------- Render ----------------
  return (
    <div style={styles.page}>
      {/* ---------- Profile Card ---------- */}
      <div style={styles.profileCard}>
        <div style={styles.imageContainer}>
          <img
            src={`http://localhost:8080/api/user/image/${user.id}?t=${Date.now()}`}
            alt="User Profile"
            style={styles.profileImage}
          />
        </div>

        <div style={styles.fileUploadContainer}>
          <label htmlFor="profileUpload" style={styles.chooseFileBtn}>Choose File</label>
          <input type="file" id="profileUpload" onChange={handleFileChange} style={{ display: "none" }} />
          <button onClick={uploadProfilePic} style={styles.uploadBtn}>Upload</button>
          <button onClick={deleteProfilePic} style={styles.deleteProfileBtn}>Delete</button>
        </div>

        <h2 style={styles.name}>{user.name}</h2>
        <p style={styles.email}>{user.email}</p>

        <div style={styles.infoBox}>
          <p><strong>Country:</strong> {user.country}</p>
          <p><strong>About Me:</strong> {user.biodetails}</p>
          <p><strong>Member Since:</strong> {new Date(user.accountCreatedAt).toLocaleDateString()}</p>
        </div>

        <div style={{ display: "flex", justifyContent: "center", gap: "1rem" }}>
          <button onClick={openProfileEdit} style={styles.editBtn}>Edit Profile Details</button>
          <button onClick={handleLogout} style={styles.logoutBtn}>Logout</button>
        </div>

        <div style={{ marginTop: "2rem", textAlign: "center" }}>
  <button
    onClick={deleteAccount}
    onMouseEnter={(e) => e.currentTarget.style.boxShadow = "0 0 25px rgba(231,76,60,0.8)"}
    onMouseLeave={(e) => e.currentTarget.style.boxShadow = "0 0 15px rgba(231,76,60,0.6)"}
    style={styles.deleteAccountBtn}
  >
    Delete Account
  </button>
</div>

      </div>

      {/* ---------- Upload New Video Section ---------- */}
<div style={styles.uploadSection}>
  <h2 style={styles.uploadHeading}>üé¨ Upload Your New Video</h2>
  <p style={styles.uploadSubText}>
    Share your creativity with the world! Fill in the details below and upload your masterpiece.
  </p>

  <div style={styles.uploadForm}>
    <input
      type="text"
      placeholder="Enter video title"
      value={uploadData.title}
      onChange={(e) => setUploadData({ ...uploadData, title: e.target.value })}
      style={styles.inputLarge}
    />
    <textarea
      placeholder="Write a catchy description..."
      value={uploadData.description}
      onChange={(e) => setUploadData({ ...uploadData, description: e.target.value })}
      style={styles.textareaLarge}
    />
    <input type="file" accept="video/*" onChange={handleVideoChange} style={styles.fileInput} />

    <button
      onClick={handleUpload}
      style={styles.bigUploadBtn}
      disabled={uploading}
    >
      {uploading ? "Uploading..." : "üöÄ Upload Video"}
    </button>
  </div>
</div>


      {/* ---------- Videos Section ---------- */}
      <div style={styles.videosContainer}>
        {videos.length === 0 && <p style={{ color: "#ccc" }}>No videos uploaded yet.</p>}
        {videos.map((vid, index) => (
          <div key={vid.videoId} style={styles.videoCard}>
            <video
              width="100%"
              controls
              ref={(el) => (videoRefs.current[index] = el)}
              onPlay={() => handlePlay(index)}
              style={styles.video}
            >
              <source src={`http://localhost:8080/api/v3/videos/stream/${vid.videoId}`} />
            </video>

            {editingIndex === index ? (
              <div style={styles.editBox}>
                <input
                  type="text"
                  value={editData.title}
                  onChange={(e) => setEditData({ ...editData, title: e.target.value })}
                  style={styles.input}
                  placeholder="Video Title"
                />
                <textarea
                  value={editData.description}
                  onChange={(e) => setEditData({ ...editData, description: e.target.value })}
                  style={styles.textarea}
                  placeholder="Video Description"
                />
                <div style={styles.buttonGroup}>
                  <button onClick={() => saveEdit(vid.videoId)} style={styles.saveBtn}>Save</button>
                  <button onClick={cancelEdit} style={styles.cancelBtn}>Cancel</button>
                </div>
              </div>
            ) : (
              <div style={styles.videoInfo}>
                <h3 style={styles.videoTitle}>{vid.title}</h3>
                <p style={styles.videoDesc}>{vid.description}</p>
                <span style={styles.uploadedAt}>{new Date(vid.uploadedAt).toLocaleString()}</span>
                <div style={styles.buttonGroup}>
                  <button onClick={() => startEdit(index)} style={styles.editBtn}>Update</button>
                  <button onClick={() => deleteVideo(vid.videoId)} style={styles.deleteBtn}>Delete</button>
                </div>
              </div>
            )}
          </div>
        ))}
      </div>

      {/* ---------- Edit Profile Modal ---------- */}
      {showProfileEdit && (
        <div style={styles.modalOverlay}>
          <div style={styles.modal}>
            <h2 style={{ color: "#f39c12", textAlign: "center" }}>Edit Profile</h2>

            <input
              type="text"
              placeholder="Full Name"
              value={profileEditData.name}
              onChange={(e) => setProfileEditData({ ...profileEditData, name: e.target.value })}
              style={styles.input}
            />
            <input
              type="password"
              placeholder="New Password"
              value={profileEditData.password}
              onChange={(e) => setProfileEditData({ ...profileEditData, password: e.target.value })}
              style={styles.input}
            />
            <input
              type="password"
              placeholder="Confirm Password"
              value={profileEditData.confirmPassword}
              onChange={(e) => setProfileEditData({ ...profileEditData, confirmPassword: e.target.value })}
              style={styles.input}
            />
            {passwordError && <p style={{ color: "red", fontSize: "0.9rem" }}>{passwordError}</p>}

            <input
              type="text"
              placeholder="Country"
              value={profileEditData.country}
              onChange={(e) => setProfileEditData({ ...profileEditData, country: e.target.value })}
              style={styles.input}
            />
            <textarea
              placeholder="Bio / About Me"
              value={profileEditData.biodetails}
              onChange={(e) => setProfileEditData({ ...profileEditData, biodetails: e.target.value })}
              style={styles.textarea}
            />

            <div style={styles.buttonGroup}>
              <button onClick={saveProfileChanges} style={styles.saveBtn}>Save</button>
              <button onClick={closeProfileEdit} style={styles.cancelBtn}>Cancel</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ---------------- Styles ----------------
const styles = {
  page: {
    minHeight: "100vh",
    background: "linear-gradient(135deg, #0f0f0f, #1e1e1e)",
    display: "flex",
    flexDirection: "column",
    alignItems: "center",
    padding: "2rem",
    fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
  },

  profileCard: {
    background: "linear-gradient(145deg, #1e1e1e, #2a2a2a)",
    borderRadius: "25px",
    padding: "3rem",
    width: "520px",
    textAlign: "center",
    boxShadow: "0 12px 40px rgba(0,0,0,0.8)",
    marginBottom: "3rem",
  },

  imageContainer: {
    display: "flex",
    justifyContent: "center",
    marginBottom: "1rem",
  },

  profileImage: {
    width: "150px",
    height: "150px",
    borderRadius: "50%",
    objectFit: "cover",
    border: "4px solid #f39c12",
    boxShadow: "0 0 20px rgba(243,156,18,0.7)",
  },

  fileUploadContainer: {
    margin: "1rem 0",
    display: "flex",
    justifyContent: "center",
    alignItems: "center",
    gap: "0.5rem",
  },

  chooseFileBtn: {
    padding: "8px 16px",
    borderRadius: "8px",
    background: "linear-gradient(90deg, #3498db, #2980b9)",
    color: "white",
    fontWeight: "bold",
    cursor: "pointer",
  },

  uploadBtn: {
    padding: "8px 18px",
    borderRadius: "8px",
    border: "none",
    background: "linear-gradient(90deg, #2ecc71, #27ae60)",
    color: "white",
    fontWeight: "bold",
    cursor: "pointer",
  },

  deleteProfileBtn: {
    padding: "8px 18px",
    borderRadius: "8px",
    border: "none",
    background: "linear-gradient(90deg, #e74c3c, #c0392b)",
    color: "white",
    fontWeight: "bold",
    cursor: "pointer",
  },

  name: {
    margin: "10px 0 5px 0",
    fontSize: "1.9rem",
    color: "#f39c12",
  },

  email: {
    fontSize: "1rem",
    color: "#ccc",
    marginBottom: "1.5rem",
  },

  infoBox: {
    background: "#2f2f2f",
    borderRadius: "15px",
    padding: "1rem",
    textAlign: "left",
    fontSize: "0.95rem",
    lineHeight: "1.6",
    marginBottom: "1.5rem",
    color: "#ccc",
  },

  logoutBtn: {
    padding: "12px 25px",
    borderRadius: "10px",
    border: "none",
    background: "#e74c3c",
    color: "white",
    fontWeight: "bold",
    cursor: "pointer",
  },

  videosContainer: {
    display: "grid",
    gridTemplateColumns: "repeat(auto-fit, minmax(360px, 1fr))",
    gap: "2rem",
    width: "100%",
    maxWidth: "1200px",
  },

  videoCard: {
    background: "#222",
    borderRadius: "15px",
    padding: "1rem",
    boxShadow: "0 5px 15px rgba(0,0,0,0.5)",
    display: "flex",
    flexDirection: "column",
  },

  video: {
    borderRadius: "12px",
    marginBottom: "0.8rem",
  },

  videoInfo: {
    color: "#fff",
  },

  videoTitle: {
    fontSize: "1.2rem",
    marginBottom: "0.3rem",
    color: "#f39c12",
  },

  videoDesc: {
    fontSize: "0.95rem",
    marginBottom: "0.3rem",
    color: "#ccc",
  },

  uploadedAt: {
    fontSize: "0.8rem",
    color: "#aaa",
  },

  buttonGroup: {
    display: "flex",
    gap: "0.5rem",
    marginTop: "0.5rem",
    justifyContent: "center",
  },

  editBtn: {
    padding: "6px 12px",
    borderRadius: "6px",
    border: "none",
    background: "#3498db",
    color: "white",
    cursor: "pointer",
  },

  deleteBtn: {
    padding: "6px 12px",
    borderRadius: "6px",
    border: "none",
    background: "#e74c3c",
    color: "white",
    cursor: "pointer",
  },

  saveBtn: {
    padding: "6px 12px",
    borderRadius: "6px",
    border: "none",
    background: "#2ecc71",
    color: "white",
    cursor: "pointer",
  },

  cancelBtn: {
    padding: "6px 12px",
    borderRadius: "6px",
    border: "none",
    background: "#95a5a6",
    color: "white",
    cursor: "pointer",
  },

  editBox: {
    display: "flex",
    flexDirection: "column",
    gap: "0.5rem",
  },

  input: {
    padding: "8px",
    borderRadius: "6px",
    border: "1px solid #555",
    background: "#1c1c1c",
    color: "#fff",
  },

  textarea: {
    padding: "8px",
    borderRadius: "6px",
    border: "1px solid #555",
    background: "#1c1c1c",
    color: "#fff",
    resize: "vertical",
  },

  modalOverlay: {
    position: "fixed",
    top: 0,
    left: 0,
    width: "100vw",
    height: "100vh",
    backgroundColor: "rgba(0,0,0,0.7)",
    display: "flex",
    justifyContent: "center",
    alignItems: "center",
    zIndex: 999,
  },

  modal: {
    background: "#1e1e1e",
    borderRadius: "15px",
    padding: "2rem",
    width: "400px",
    display: "flex",
    flexDirection: "column",
    gap: "1rem",
    boxShadow: "0 10px 25px rgba(0,0,0,0.7)",
  },

  uploadSection: {
  background: "linear-gradient(145deg, #1a1a1a, #2b2b2b)",
  borderRadius: "25px",
  padding: "3rem 2rem",
  width: "650px",
  textAlign: "center",
  boxShadow: "0 8px 40px rgba(0,0,0,0.8)",
  marginBottom: "3rem",
  transition: "transform 0.3s ease, box-shadow 0.3s ease",
},
uploadSectionHover: {
  transform: "scale(1.02)",
  boxShadow: "0 0 30px rgba(243,156,18,0.4)",
},
uploadHeading: {
  color: "#f39c12",
  fontSize: "1.8rem",
  marginBottom: "0.5rem",
},
uploadSubText: {
  color: "#ccc",
  fontSize: "0.95rem",
  marginBottom: "2rem",
},
uploadForm: {
  display: "flex",
  flexDirection: "column",
  gap: "1rem",
  alignItems: "center",
},
inputLarge: {
  width: "90%",
  padding: "12px 14px",
  borderRadius: "10px",
  border: "1px solid #555",
  background: "#1c1c1c",
  color: "#fff",
  fontSize: "1rem",
  outline: "none",
},
textareaLarge: {
  width: "90%",
  padding: "12px 14px",
  borderRadius: "10px",
  border: "1px solid #555",
  background: "#1c1c1c",
  color: "#fff",
  fontSize: "1rem",
  minHeight: "120px",
  resize: "vertical",
  outline: "none",
},
fileInput: {
  width: "90%",
  padding: "10px",
  borderRadius: "10px",
  background: "#1c1c1c",
  color: "#fff",
  border: "1px solid #555",
  cursor: "pointer",
},
bigUploadBtn: {
  width: "90%",
  padding: "14px 0",
  borderRadius: "12px",
  border: "none",
  background: "linear-gradient(90deg,#f39c12,#e67e22)",
  color: "white",
  fontWeight: "bold",
  fontSize: "1.1rem",
  cursor: "pointer",
  boxShadow: "0 0 20px rgba(243,156,18,0.5)",
  transition: "all 0.3s ease",
},
bigUploadBtnHover: {
  background: "linear-gradient(90deg,#f1c40f,#e67e22)",
  boxShadow: "0 0 25px rgba(243,156,18,0.7)",
},

deleteAccountBtn: {
  padding: "12px 30px",
  borderRadius: "10px",
  border: "none",
  background: "linear-gradient(90deg, #ff4b2b, #c0392b)",
  color: "white",
  fontWeight: "bold",
  cursor: "pointer",
  boxShadow: "0 0 15px rgba(231,76,60,0.6)",
  transition: "all 0.3s ease",
  marginTop: "10px",
},


};


export default UserDetails;
